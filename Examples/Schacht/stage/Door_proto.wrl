#VRML V2.0 utf8

PROTO Door [
  exposedField  SFBool    offset		FALSE
  exposedField  SFBool    enabled		FALSE
  exposedField  SFTime    startTime		0
  exposedField  SFTime    stopTime		0
  eventOut      SFBool    isActive		
  eventOut      SFTime    enterTime		
  eventOut      SFTime    exitTime		
]
{
  PROTO Data [
    exposedField  SFBool    offset		FALSE
    exposedField  SFBool    enabled		FALSE
    exposedField  SFTime    startTime		0
    exposedField  SFTime    stopTime		0
  ]
  {
    Group { 
      children [ ]
    }
  }

  DEF _door Script { 
    eventOut  SFBool    isActive IS isActive
    eventOut  SFTime    enterTime IS enterTime
    eventOut  SFTime    exitTime IS exitTime
    eventIn   SFBool    set_offset
    eventIn   SFBool    set_enabled
    eventIn   SFTime    set_startTime
    eventIn   SFTime    set_stopTime
    field     SFBool    offset FALSE
    field     SFBool    next FALSE
    field     SFNode    data DEF Data Data { 
      offset IS offset
      enabled IS enabled
      startTime IS startTime
      stopTime IS stopTime
    }
    url "vrmlscript:
function set_offset(value, time)
{
	if (offset == value) { return; }

	if (data.enabled) {
		next = TRUE;
	} else {
		next = FALSE;
		offset = value;
		if (value) {
			if (!isActive) isActive = value;
			enterTime = time;			
		} else {
			if (isActive) {
				exitTime = time;
			}
		}
	}
}
function set_enabled(value, time)
{
	if (!value && next) {
		if (offset != data.offset) data.offset = !offset;
	} else if (!value && !offset && !next) {
		isActive = FALSE;
	}
}
function set_startTime(value, time) { data.offset = TRUE; }
function set_stopTime(value, time) { data.offset = FALSE; }
"
    directOutput TRUE
	mustEvaluate TRUE
  }

  ROUTE Data.offset_changed TO _door.set_offset
  ROUTE Data.enabled_changed TO _door.set_enabled
  ROUTE Data.startTime_changed TO _door.set_startTime
  ROUTE Data.stopTime_changed TO _door.set_stopTime
}

